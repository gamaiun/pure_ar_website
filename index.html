<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.0/dist/aframe.min.js"></script>
    <script src="https://rawcdn.githack.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/aframe@1.4.0/dist/aframe.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://rawcdn.githack.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      function initARScene() {
        document.body.innerHTML += `<h3 style="color:blue;">Loading AR Scene...</h3>`;

        // Firebase Storage Public URL for the 3D model
        const modelSrc =
          "https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8";
        // Parse URL parameters dynamically
        const urlParams = new URLSearchParams(window.location.search);

        // Extract values with defaults
        const gpsLat = parseFloat(urlParams.get("gpsLat")) || 33.20322;
        const gpsLon = parseFloat(urlParams.get("gpsLon")) || 35.57516;
        const posX = parseFloat(urlParams.get("x")) || 0.0;
        const posY = parseFloat(urlParams.get("y")) || 0.0;
        const posZ = parseFloat(urlParams.get("z")) || 0.0;
        const scale = parseFloat(urlParams.get("scale")) || 1.0;

        console.log("GPS Lat:", gpsLat, "GPS Lon:", gpsLon);
        console.log("Position Offset:", posX, posY, posZ);
        console.log("Scale:", scale);
        console.log("Model URL:", modelSrc);

        // ðŸ”¹ Wait for A-Frame to be fully ready before modifying the scene
        function waitForScene() {
          const scene = document.querySelector("a-scene");
          if (!scene) {
            console.warn("A-Frame scene not found yet, retrying...");
            setTimeout(waitForScene, 500); // Retry after 500ms
            return;
          }

          scene.addEventListener("loaded", function () {
            console.log("A-Frame Scene Loaded!");

            const model = document.createElement("a-entity");
            model.setAttribute(
              "gps-entity-place",
              `latitude: ${gpsLat}; longitude: ${gpsLon}`
            );
            model.setAttribute("gltf-model", modelSrc);
            model.setAttribute("scale", `${scale} ${scale} ${scale}`);
            model.setAttribute("position", `${posX} ${posY} ${posZ}`);
            model.setAttribute("rotation", "0 180 0");

            model.addEventListener("model-loaded", () => {
              console.log("Model successfully loaded!");
              document.body.innerHTML += `<h3 style="color:green;">Model Loaded Successfully!</h3>`;
            });

            model.addEventListener("error", (e) => {
              console.error("Model loading error:", e);
              document.body.innerHTML = `<h2 style="color:red;">Error: Model Failed to Load</h2>`;
            });

            scene.appendChild(model);
          });
        }

        waitForScene();
      }

      // Ensure script runs only when the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", initARScene);

      // Global error handler
      window.onerror = function (message, source, lineno, colno, error) {
        document.body.innerHTML = `
          <h2 style="color:red">Error Detected:</h2>
          <p>${message}</p>
          <p>Source: ${source}</p>
          <p>Line: ${lineno}, Column: ${colno}</p>
        `;
        console.error(
          "Error:",
          message,
          "at",
          source,
          "Line:",
          lineno,
          "Col:",
          colno,
          "Details:",
          error
        );
      };
    </script>
  </head>

  <body>
    <a-scene embedded arjs="sourceType: webcam;">
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </body>
</html>
