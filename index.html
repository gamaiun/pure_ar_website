<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>

    <style>
      .a-enter-vr,
      .a-enter-ar,
      .a-enter-vr-button,
      .a-enter-ar-button {
        position: fixed !important;
        bottom: 20px !important; /* Position near the bottom */
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 9999 !important; /* Ensure they are always on top */
        width: auto !important;
        padding: 10px 15px !important; /* Add padding for better clickability */
      }

      /* Add spacing between buttons */
      .a-enter-vr {
        bottom: 70px !important;
      } /* Push the VR button up */
      .a-enter-ar {
        bottom: 20px !important;
      } /* Keep AR button lower */
    </style>
  </head>

  <!-- <script>
    function logMessage(message) {
      document.body.innerHTML += `<p style="color:blue;">${message}</p>`;
      console.log(message);
    }

    async function requestPermissions() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        logMessage("‚úÖ Camera permission granted!");
      } catch (err) {
        logMessage("‚ùå Camera permission denied: " + err);
      }
    }

    function initARScene() {
      logMessage("üîπ Initializing AR Scene...");

      const modelSrc =
        "https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8";

      const urlParams = new URLSearchParams(window.location.search);
      const gpsLat = parseFloat(urlParams.get("gpsLat")) || 33.20322;
      const gpsLon = parseFloat(urlParams.get("gpsLon")) || 35.57516;
      const posX = parseFloat(urlParams.get("x")) || 0.0;
      const posY = parseFloat(urlParams.get("y")) || 0.0;
      const posZ = parseFloat(urlParams.get("z")) || 0.0;
      const scale = parseFloat(urlParams.get("scale")) || 1.0;

      logMessage(`üìç GPS: ${gpsLat}, ${gpsLon}`);
      logMessage(`üìè Position Offset: x=${posX}, y=${posY}, z=${posZ}`);
      logMessage(`üìå Scale: ${scale}`);
      logMessage(
        `üñºÔ∏è Model URL: <a href="${modelSrc}" target="_blank">${modelSrc}</a>`
      );

      fetch(modelSrc)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          logMessage("‚úÖ Model is accessible from Firebase!");
        })
        .catch((error) => logMessage(`‚ùå Model access error: ${error}`));

      function waitForScene() {
        const scene = document.querySelector("a-scene");
        if (!scene) {
          logMessage("‚è≥ Waiting for A-Frame scene to load...");
          setTimeout(waitForScene, 500);
          return;
        }

        scene.addEventListener("loaded", function () {
          logMessage("‚úÖ A-Frame Scene Loaded!");

          const model = document.createElement("a-entity");
          model.setAttribute(
            "gps-entity-place",
            `latitude: ${gpsLat}; longitude: ${gpsLon}`
          );
          model.setAttribute("gltf-model", modelSrc);
          model.setAttribute("scale", `${scale} ${scale} ${scale}`);
          //   model.setAttribute("position", `${posX} ${posY} ${posZ}`);
          model.setAttribute("position", "0 1 -3");
          model.setAttribute("rotation", "0 180 0");
          model.setAttribute("crossorigin", "anonymous");

          model.addEventListener("model-loaded", () => {
            logMessage("‚úÖ Model successfully loaded and displayed!");
          });

          model.addEventListener("error", (e) => {
            logMessage(`‚ùå Model load error: ${e}`);
          });

          // ‚úÖ Add the model with a slight delay to ensure A-Frame is ready
          setTimeout(() => {
            scene.appendChild(model);
            logMessage("‚úÖ Model added to scene!");
          }, 1000);
        });
      }

      waitForScene();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await requestPermissions();
      initARScene();
    });

    window.onerror = function (message, source, lineno, colno, error) {
      document.body.innerHTML += `
          <h2 style="color:red">‚ùå Error Detected:</h2>
          <p>${message}</p>
          <p>Source: ${source}</p>
          <p>Line: ${lineno}, Column: ${colno}</p>
        `;
      console.error(
        "Error:",
        message,
        "at",
        source,
        "Line:",
        lineno,
        "Col:",
        colno,
        "Details:",
        error
      );
    };
  </script> -->
  <script>
    function logMessage(message) {
      document.body.innerHTML += `<p style="color:blue;">${message}</p>`;
      console.log(message);
    }

    async function requestPermissions() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        logMessage("‚úÖ Camera permission granted!");
      } catch (err) {
        logMessage("‚ùå Camera permission denied: " + err);
      }
    }

    function ensureSingleScene() {
      const existingScene = document.querySelector("a-scene");
      if (existingScene && existingScene.parentNode) {
        logMessage("‚ö†Ô∏è Removing old A-Frame scene to prevent WebGL issues...");
        existingScene.parentNode.removeChild(existingScene);
      } else {
        logMessage("‚úÖ No existing A-Frame scene found. Proceeding...");
      }
    }
    function initARScene() {
      ensureSingleScene(); // ‚úÖ Prevent multiple WebGL contexts
      logMessage("üîπ Initializing AR Scene...");

      const modelSrc =
        "https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8";

      const urlParams = new URLSearchParams(window.location.search);
      const gpsLat = parseFloat(urlParams.get("gpsLat")) || 33.20322;
      const gpsLon = parseFloat(urlParams.get("gpsLon")) || 35.57516;
      const posX = parseFloat(urlParams.get("x")) || 0.0;
      const posY = parseFloat(urlParams.get("y")) || 0.0;
      const posZ = parseFloat(urlParams.get("z")) || 0.0;
      const scale = parseFloat(urlParams.get("scale")) || 1.0;

      logMessage(`üìç GPS: ${gpsLat}, ${gpsLon}`);
      logMessage(`üìè Position Offset: x=${posX}, y=${posY}, z=${posZ}`);
      logMessage(`üìå Scale: ${scale}`);
      logMessage(
        `üñºÔ∏è Model URL: <a href="${modelSrc}" target="_blank">${modelSrc}</a>`
      );

      fetch(modelSrc)
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          logMessage("‚úÖ Model is accessible from Firebase!");
        })
        .catch((error) => logMessage(`‚ùå Model access error: ${error}`));

      function waitForScene() {
        const scene = document.querySelector("a-scene");
        if (!scene) {
          logMessage("‚è≥ Waiting for A-Frame scene to load...");
          setTimeout(waitForScene, 500);
          return;
        }

        scene.addEventListener("loaded", function () {
          logMessage("‚úÖ A-Frame Scene Loaded!");

          // ‚úÖ Remove old model if it exists
          const existingModel = document.querySelector("[gltf-model]");
          if (existingModel) {
            logMessage("‚ö†Ô∏è Removing old model...");
            existingModel.parentNode.removeChild(existingModel);
          }

          const model = document.createElement("a-entity");
          model.setAttribute(
            "gps-entity-place",
            `latitude: ${gpsLat}; longitude: ${gpsLon}`
          );
          model.setAttribute("gltf-model", modelSrc);
          model.setAttribute("scale", `${scale} ${scale} ${scale}`);
          model.setAttribute("position", "0 1 -3"); // ‚úÖ Visible in front
          model.setAttribute("rotation", "0 180 0");
          model.setAttribute("crossorigin", "anonymous");

          model.addEventListener("model-loaded", () => {
            logMessage("‚úÖ Model successfully loaded and displayed!");
          });

          model.addEventListener("error", (e) => {
            logMessage(`‚ùå Model load error: ${e}`);
          });

          scene.appendChild(model);
        });
      }

      waitForScene();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await requestPermissions();
      initARScene();
    });

    window.onerror = function (message, source, lineno, colno, error) {
      document.body.innerHTML += `
          <h2 style="color:red">‚ùå Error Detected:</h2>
          <p>${message}</p>
          <p>Source: ${source}</p>
          <p>Line: ${lineno}, Column: ${colno}</p>
        `;
      console.error(
        "Error:",
        message,
        "at",
        source,
        "Line:",
        lineno,
        "Col:",
        colno,
        "Details:",
        error
      );
    };
  </script>

  <body>
    <a-scene embedded arjs="sourceType: webcam;">
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </body>
</html>
