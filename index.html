<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>

    <script>
      function logMessage(message) {
        document.body.innerHTML += `<p style="color:blue;">${message}</p>`;
        console.log(message);
      }

      async function requestPermissions() {
        try {
          await navigator.mediaDevices.getUserMedia({ video: true });
          logMessage("‚úÖ Camera permission granted!");
        } catch (err) {
          logMessage("‚ùå Camera permission denied: " + err);
        }
      }

      function initARScene() {
        logMessage("üîπ Initializing AR Scene...");

        // Firebase Storage Public URL for the 3D model
        const modelSrc =
          "https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8";

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const gpsLat = parseFloat(urlParams.get("gpsLat")) || 33.20322;
        const gpsLon = parseFloat(urlParams.get("gpsLon")) || 35.57516;
        const posX = parseFloat(urlParams.get("x")) || 0.0;
        const posY = parseFloat(urlParams.get("y")) || 0.0;
        const posZ = parseFloat(urlParams.get("z")) || 0.0;
        const scale = parseFloat(urlParams.get("scale")) || 1.0;

        logMessage(`üìç GPS: ${gpsLat}, ${gpsLon}`);
        logMessage(`üìè Position Offset: x=${posX}, y=${posY}, z=${posZ}`);
        logMessage(`üìå Scale: ${scale}`);
        logMessage(
          `üñºÔ∏è Model URL: <a href="${modelSrc}" target="_blank">${modelSrc}</a>`
        );

        // Verify if the Firebase model is accessible
        fetch(modelSrc)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            logMessage("‚úÖ Model is accessible from Firebase!");
          })
          .catch((error) => logMessage(`‚ùå Model access error: ${error}`));

        // Wait for A-Frame to load before modifying the scene
        function waitForScene() {
          const scene = document.querySelector("a-scene");
          if (!scene) {
            logMessage("‚è≥ Waiting for A-Frame scene to load...");
            setTimeout(waitForScene, 500);
            return;
          }

          scene.addEventListener("loaded", function () {
            logMessage("‚úÖ A-Frame Scene Loaded!");

            const model = document.createElement("a-entity");
            model.setAttribute(
              "gps-entity-place",
              `latitude: ${gpsLat}; longitude: ${gpsLon}`
            );
            model.setAttribute("gltf-model", modelSrc);
            model.setAttribute("scale", `${scale} ${scale} ${scale}`);
            model.setAttribute("position", `${posX} ${posY} ${posZ}`);
            model.setAttribute("rotation", "0 180 0");

            model.addEventListener("model-loaded", () =>
              logMessage("‚úÖ Model successfully loaded and displayed!")
            );
            model.addEventListener("error", (e) =>
              logMessage(`‚ùå Model load error: ${e}`)
            );

            scene.appendChild(model);
          });
        }

        waitForScene();
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await requestPermissions(); // Request camera access
        initARScene();
      });

      window.onerror = function (message, source, lineno, colno, error) {
        document.body.innerHTML += `
          <h2 style="color:red">‚ùå Error Detected:</h2>
          <p>${message}</p>
          <p>Source: ${source}</p>
          <p>Line: ${lineno}, Column: ${colno}</p>
        `;
        console.error(
          "Error:",
          message,
          "at",
          source,
          "Line:",
          lineno,
          "Col:",
          colno,
          "Details:",
          error
        );
      };
    </script>
  </head>

  <body>
    <a-scene embedded arjs="sourceType: webcam;">
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>
  </body>
</html>
