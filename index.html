<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AR Objects with External GPS</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
      /* Hide scene until ready */
      a-scene {
        display: none;
      }
      a-scene.ready {
        display: block;
      }
      /* Loading indicator */
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: Arial, sans-serif;
        font-size: 20px;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div id="loading">Loading model...</div>
    <a-scene
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="logarithmicDepthBuffer: true;"
    >
      <!-- Camera with GPS tracking (uses user's location to compare) -->
      <a-camera gps-camera rotation-reader position="0 1.6 0"></a-camera>

      <!-- 3D Model - Positioned using URL-provided gpsLat and gpsLon -->
      <a-entity
        id="sphere"
        position="-2 0.5 -2"
        scale="0.5 0.5 0.5"
        gltf-model="url(https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8)"
      ></a-entity>
    </a-scene>

    <script>
      window.onload = () => {
        const scene = document.querySelector("a-scene");
        const modelEntity = document.querySelector("#sphere");
        const loadingDiv = document.querySelector("#loading");

        // Function to parse URL query parameters
        function getQueryParams() {
          const params = new URLSearchParams(window.location.search);
          return {
            gpsLat: parseFloat(params.get("gpsLat")),
            gpsLon: parseFloat(params.get("gpsLon")),
          };
        }

        // Wait for scene to load
        scene.addEventListener("loaded", () => {
          console.log("Scene core loaded");

          // Wait for model to load
          modelEntity.addEventListener("model-loaded", () => {
            console.log("3D model loaded");

            // Get GPS coordinates from URL
            const { gpsLat, gpsLon } = getQueryParams();

            if (gpsLat && gpsLon) {
              console.log(
                `Using URL coordinates: Lat ${gpsLat}, Lon ${gpsLon}`
              );

              // Set the object's position using URL-provided coordinates
              modelEntity.setAttribute("gps-entity-place", {
                latitude: gpsLat,
                longitude: gpsLon,
              });

              // Show the scene
              scene.classList.add("ready");
              loadingDiv.style.display = "none";
            } else {
              console.error("Missing gpsLat or gpsLon in URL.");
              loadingDiv.textContent = "Error: Missing GPS coordinates in URL.";
            }
          });

          // Handle model loading errors
          modelEntity.addEventListener("model-error", (event) => {
            console.error("Model failed to load:", event.detail);
            loadingDiv.textContent = "Error loading model. Check console.";
          });
        });
      };
    </script>
  </body>
</html>
