<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>

    <style>
      .a-enter-vr,
      .a-enter-vr-button {
        display: none !important;
      }
      .a-enter-ar,
      .a-enter-ar-button {
        position: fixed !important;
        bottom: 20px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
        z-index: 9999 !important;
        width: auto !important;
        padding: 10px 15px !important;
      }
    </style>
  </head>

  <script>
    function logMessage(message) {
      document.body.innerHTML += `<p style="color:blue;">${message}</p>`;
      console.log(message);
    }

    async function requestPermissions() {
      try {
        await navigator.mediaDevices.getUserMedia({ video: true });
        logMessage("‚úÖ Camera permission granted!");
      } catch (err) {
        logMessage("‚ùå Camera permission denied: " + err);
      }
    }

    function initARScene() {
      logMessage("üîπ Initializing AR Scene...");

      const modelSrc =
        "https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8";

      const urlParams = new URLSearchParams(window.location.search);
      const gpsLat = parseFloat(urlParams.get("gpsLat"));
      const gpsLon = parseFloat(urlParams.get("gpsLon"));
      const posX = parseFloat(urlParams.get("x")) || 0.0;
      const posY = parseFloat(urlParams.get("y")) || 0.0;
      const posZ = parseFloat(urlParams.get("z")) || 0.0;
      const scale = parseFloat(urlParams.get("scale")) || 1.0;

      if (isNaN(gpsLat) || isNaN(gpsLon)) {
        logMessage("‚ùå Missing or invalid GPS coordinates!");
        return;
      }

      logMessage(`üìç Received GPS: ${gpsLat}, ${gpsLon}`);
      logMessage(`üìè Position Offset: x=${posX}, y=${posY}, z=${posZ}`);
      logMessage(`üìå Scale: ${scale}`);
      logMessage(
        `üñºÔ∏è Model URL: <a href="${modelSrc}" target="_blank">${modelSrc}</a>`
      );

      addModelToScene(gpsLat, gpsLon, posX, posY, posZ);
    }

    function addModelToScene(gpsLat, gpsLon, posX, posY, posZ) {
      const scene = document.querySelector("a-scene");

      if (!scene) {
        logMessage("‚ùå Scene not found!");
        return;
      }

      logMessage("‚úÖ Adding model at GPS location...");

      // Create Debug Marker (Red Sphere)
      const debugMarker = document.createElement("a-sphere");
      debugMarker.setAttribute("radius", "0.5");
      debugMarker.setAttribute("color", "red");
      debugMarker.setAttribute(
        "gps-entity-place",
        `latitude: ${gpsLat}; longitude: ${gpsLon}`
      );
      scene.appendChild(debugMarker);
      logMessage("‚úÖ Debug marker added to scene!");

      // Create 3D Model
      const model = document.createElement("a-entity");
      model.setAttribute(
        "gltf-model",
        "https://firebasestorage.googleapis.com/v0/b/fireye-91940.firebasestorage.app/o/models%2FARObject1.glb?alt=media&token=a68ba586-0c9b-48c4-9bb1-9e25f430e1c8"
      );
      model.setAttribute(
        "gps-entity-place",
        `latitude: ${gpsLat}; longitude: ${gpsLon}`
      );
      model.setAttribute("scale", "1 1 1");
      model.setAttribute("rotation", "0 180 0");
      model.setAttribute("crossorigin", "anonymous");

      model.addEventListener("model-loaded", () => {
        logMessage("‚úÖ Model loaded successfully!");
      });

      model.addEventListener("error", (e) => {
        logMessage(`‚ùå Model load error: ${e}`);
      });

      scene.appendChild(model);
      logMessage("‚úÖ Model added to scene!");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await requestPermissions();
      initARScene();
    });

    window.onerror = function (message, source, lineno, colno, error) {
      document.body.innerHTML += `
          <h2 style="color:red">‚ùå Error Detected:</h2>
          <p>${message}</p>
          <p>Source: ${source}</p>
          <p>Line: ${lineno}, Column: ${colno}</p>
        `;
      console.error(
        "Error:",
        message,
        "at",
        source,
        "Line:",
        lineno,
        "Col:",
        colno,
        "Details:",
        error
      );
    };
  </script>

  <body>
    <a-scene embedded arjs="sourceType: webcam; trackingMethod: best;">
      <a-camera gps-camera rotation-reader gpsMinDistance="2"></a-camera>

      <script>
        document
          .querySelector("[gps-camera]")
          .addEventListener("gps-camera-update", (event) => {
            logMessage(
              `üìç GPS Updated: ${event.detail.position.latitude}, ${event.detail.position.longitude}`
            );
          });
      </script>
    </a-scene>
  </body>
</html>
